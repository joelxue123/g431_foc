/* Includes ------------------------------------------------------------------*/
#include "stm32_math_sin.h"
#include "global.h"

/* Private macro -------------------------------------------------------------*/
#define SIN_MASK_512        0x0600u
#define U0_90_512           0x0400u
#define U90_180_512         0x0600u
#define U180_270_512        0x0000u
#define U270_360_512        0x0200u

/* Private variables ---------------------------------------------------------*/
// 将90度等分512份(360度等分2048份)，结果放大32768倍
const int16_t hSin_Cos_Table_512[512] = {
0x0000, 0x0064, 0x00C9, 0x012E, 0x0192, 0x01F7, 0x025C, 0x02C1, 0x0325, 0x038A, 0x03EF, 0x0453, 0x04B8, 0x051D, 0x0581, 0x05E6, 
0x064A, 0x06AF, 0x0714, 0x0778, 0x07DD, 0x0841, 0x08A6, 0x090A, 0x096F, 0x09D3, 0x0A38, 0x0A9C, 0x0B00, 0x0B65, 0x0BC9, 0x0C2D, 
0x0C91, 0x0CF6, 0x0D5A, 0x0DBE, 0x0E22, 0x0E86, 0x0EEA, 0x0F4E, 0x0FB2, 0x1016, 0x107A, 0x10DE, 0x1142, 0x11A6, 0x1209, 0x126D, 
0x12D1, 0x1334, 0x1398, 0x13FB, 0x145F, 0x14C2, 0x1526, 0x1589, 0x15EC, 0x164F, 0x16B3, 0x1716, 0x1779, 0x17DC, 0x183F, 0x18A2, 
0x1904, 0x1967, 0x19CA, 0x1A2C, 0x1A8F, 0x1AF2, 0x1B54, 0x1BB6, 0x1C19, 0x1C7B, 0x1CDD, 0x1D3F, 0x1DA1, 0x1E03, 0x1E65, 0x1EC7, 
0x1F28, 0x1F8A, 0x1FEC, 0x204D, 0x20AF, 0x2110, 0x2171, 0x21D2, 0x2234, 0x2295, 0x22F6, 0x2356, 0x23B7, 0x2418, 0x2478, 0x24D9, 
0x2539, 0x259A, 0x25FA, 0x265A, 0x26BA, 0x271A, 0x277A, 0x27DA, 0x2839, 0x2899, 0x28F8, 0x2958, 0x29B7, 0x2A16, 0x2A75, 0x2AD4, 
0x2B33, 0x2B92, 0x2BF1, 0x2C4F, 0x2CAE, 0x2D0C, 0x2D6A, 0x2DC8, 0x2E26, 0x2E84, 0x2EE2, 0x2F40, 0x2F9D, 0x2FFB, 0x3058, 0x30B5, 
0x3112, 0x316F, 0x31CC, 0x3229, 0x3285, 0x32E2, 0x333E, 0x339A, 0x33F6, 0x3452, 0x34AE, 0x350A, 0x3566, 0x35C1, 0x361D, 0x3678, 
0x36D3, 0x372E, 0x3789, 0x37E3, 0x383E, 0x3898, 0x38F2, 0x394D, 0x39A7, 0x3A00, 0x3A5A, 0x3AB4, 0x3B0D, 0x3B66, 0x3BC0, 0x3C19, 
0x3C72, 0x3CCA, 0x3D23, 0x3D7B, 0x3DD3, 0x3E2C, 0x3E84, 0x3EDB, 0x3F33, 0x3F8B, 0x3FE2, 0x4039, 0x4090, 0x40E7, 0x413E, 0x4194, 
0x41EB, 0x4241, 0x4297, 0x42ED, 0x4343, 0x4398, 0x43EE, 0x4443, 0x4498, 0x44ED, 0x4542, 0x4597, 0x45EB, 0x463F, 0x4694, 0x46E7, 
0x473B, 0x478F, 0x47E2, 0x4836, 0x4889, 0x48DC, 0x492E, 0x4981, 0x49D3, 0x4A25, 0x4A77, 0x4AC9, 0x4B1B, 0x4B6C, 0x4BBE, 0x4C0F, 
0x4C60, 0x4CB0, 0x4D01, 0x4D51, 0x4DA1, 0x4DF1, 0x4E41, 0x4E91, 0x4EE0, 0x4F30, 0x4F7F, 0x4FCD, 0x501C, 0x506B, 0x50B9, 0x5107, 
0x5155, 0x51A2, 0x51F0, 0x523D, 0x528A, 0x52D7, 0x5324, 0x5370, 0x53BD, 0x5409, 0x5455, 0x54A0, 0x54EC, 0x5537, 0x5582, 0x55CD, 
0x5617, 0x5662, 0x56AC, 0x56F6, 0x5740, 0x5789, 0x57D3, 0x581C, 0x5865, 0x58AE, 0x58F6, 0x593F, 0x5987, 0x59CF, 0x5A16, 0x5A5E, 
0x5AA5, 0x5AEC, 0x5B33, 0x5B79, 0x5BC0, 0x5C06, 0x5C4C, 0x5C91, 0x5CD7, 0x5D1C, 0x5D61, 0x5DA6, 0x5DEA, 0x5E2F, 0x5E73, 0x5EB7, 
0x5EFA, 0x5F3E, 0x5F81, 0x5FC4, 0x6006, 0x6049, 0x608B, 0x60CD, 0x610F, 0x6150, 0x6192, 0x61D3, 0x6214, 0x6254, 0x6295, 0x62D5, 
0x6315, 0x6354, 0x6394, 0x63D3, 0x6412, 0x6450, 0x648F, 0x64CD, 0x650B, 0x6549, 0x6586, 0x65C3, 0x6600, 0x663D, 0x667A, 0x66B6, 
0x66F2, 0x672E, 0x6769, 0x67A4, 0x67DF, 0x681A, 0x6854, 0x688F, 0x68C9, 0x6902, 0x693C, 0x6975, 0x69AE, 0x69E7, 0x6A1F, 0x6A57, 
0x6A8F, 0x6AC7, 0x6AFE, 0x6B35, 0x6B6C, 0x6BA3, 0x6BD9, 0x6C0F, 0x6C45, 0x6C7B, 0x6CB0, 0x6CE5, 0x6D1A, 0x6D4F, 0x6D83, 0x6DB7, 
0x6DEB, 0x6E1E, 0x6E51, 0x6E84, 0x6EB7, 0x6EE9, 0x6F1B, 0x6F4D, 0x6F7F, 0x6FB0, 0x6FE1, 0x7012, 0x7043, 0x7073, 0x70A3, 0x70D3, 
0x7102, 0x7131, 0x7160, 0x718F, 0x71BD, 0x71EB, 0x7219, 0x7246, 0x7274, 0x72A1, 0x72CD, 0x72FA, 0x7326, 0x7352, 0x737D, 0x73A8, 
0x73D3, 0x73FE, 0x7429, 0x7453, 0x747D, 0x74A6, 0x74D0, 0x74F9, 0x7521, 0x754A, 0x7572, 0x759A, 0x75C1, 0x75E9, 0x7610, 0x7637, 
0x765D, 0x7683, 0x76A9, 0x76CF, 0x76F4, 0x7719, 0x773E, 0x7762, 0x7787, 0x77AA, 0x77CE, 0x77F1, 0x7814, 0x7837, 0x785A, 0x787C, 
0x789D, 0x78BF, 0x78E0, 0x7901, 0x7922, 0x7942, 0x7962, 0x7982, 0x79A2, 0x79C1, 0x79E0, 0x79FF, 0x7A1D, 0x7A3B, 0x7A59, 0x7A76, 
0x7A93, 0x7AB0, 0x7ACD, 0x7AE9, 0x7B05, 0x7B21, 0x7B3C, 0x7B57, 0x7B72, 0x7B8C, 0x7BA6, 0x7BC0, 0x7BDA, 0x7BF3, 0x7C0C, 0x7C25, 
0x7C3D, 0x7C55, 0x7C6D, 0x7C84, 0x7C9C, 0x7CB2, 0x7CC9, 0x7CDF, 0x7CF5, 0x7D0B, 0x7D20, 0x7D35, 0x7D4A, 0x7D5E, 0x7D73, 0x7D86, 
0x7D9A, 0x7DAD, 0x7DC0, 0x7DD3, 0x7DE5, 0x7DF7, 0x7E09, 0x7E1A, 0x7E2B, 0x7E3C, 0x7E4D, 0x7E5D, 0x7E6D, 0x7E7C, 0x7E8B, 0x7E9A, 
0x7EA9, 0x7EB7, 0x7EC6, 0x7ED3, 0x7EE1, 0x7EEE, 0x7EFB, 0x7F07, 0x7F13, 0x7F1F, 0x7F2B, 0x7F36, 0x7F41, 0x7F4C, 0x7F56, 0x7F60, 
0x7F6A, 0x7F73, 0x7F7C, 0x7F85, 0x7F8E, 0x7F96, 0x7F9E, 0x7FA5, 0x7FAD, 0x7FB4, 0x7FBA, 0x7FC1, 0x7FC7, 0x7FCC, 0x7FD2, 0x7FD7, 
0x7FDC, 0x7FE0, 0x7FE4, 0x7FE8, 0x7FEC, 0x7FEF, 0x7FF2, 0x7FF5, 0x7FF7, 0x7FF9, 0x7FFB, 0x7FFC, 0x7FFD, 0x7FFE, 0x7FFE, 0x7FFF,
};


// Q15 数据范围:-1<X<0.9999695
// 计算三角函数，sin和cos,以结构体返回sin和cos的值，结果放大32768倍
// 计算sin(30)度，30/180，Q15格式表示为:30/180*32768;
// 计算sin(-45)度，hAngle = -45/180*32768
// hAngle = Angle(角度) / 180 * 32768 (-360<Angle<360)
Trig_Components Math_Trig_Functions_512(int16_t hAngle)
{
  int32_t shindex;
  uint16_t uhindex; 
  Trig_Components Local_Components;
  
  /* 11 bit index computation  */  
  shindex =((int32_t)32768 + (int32_t)hAngle); 
  uhindex = (uint16_t)shindex;
  //uhindex /= (uint16_t)32;     
  uhindex = uhindex >> 5; 

  switch ((uint16_t)(uhindex) & SIN_MASK_512) 
  {
  case U0_90_512:
    Local_Components.hSin = hSin_Cos_Table_512[uhindex & 0x1FF];
    Local_Components.hCos = hSin_Cos_Table_512[0x1FFu-(uhindex & 0x1FF)];
    break;
  
  case U90_180_512:  
     Local_Components.hSin = hSin_Cos_Table_512[0x1FFu-(uhindex & 0x1FF)];
     Local_Components.hCos = -hSin_Cos_Table_512[uhindex & 0x1FF];
    break;
  
  case U180_270_512:
     Local_Components.hSin = -hSin_Cos_Table_512[uhindex & 0x1FF];
     Local_Components.hCos = -hSin_Cos_Table_512[0x1FFu-(uhindex & 0x1FF)];
    break;
  
  case U270_360_512:
     Local_Components.hSin =  -hSin_Cos_Table_512[0x1FFu-(uhindex & 0x1FF)];
     Local_Components.hCos =  hSin_Cos_Table_512[uhindex & 0x1FF]; 
    break;
  default:
    break;
  }
  return (Local_Components);
}


// 将360度等分EN_360份，求sin，计算结果放大32768倍
// input：0 <= angle <= EN_360
s32 Math_Sin_EN360(u16 angle)
{
  Trig_Components Trig_temp;
  s32 angle_temp = 0; 
  angle_temp = (int)angle << 15;
  angle_temp /= EN_180;    
  Trig_temp = Math_Trig_Functions_512(angle_temp);  
  return Trig_temp.hSin;
}


// 将360度等分EN_360份，求cos，计算结果放大32768倍
// input：0 <= angle <= EN_360
s32 Math_Cos_EN360(u16 angle)
{
  Trig_Components Trig_temp;
  s32 angle_temp = 0;
  
  angle_temp = (int)angle << 15;
  
  angle_temp /= EN_180;
    
  Trig_temp = Math_Trig_Functions_512(angle_temp);
  
  return Trig_temp.hCos;
}

#if 0
#include "timer.h"
#include "arm_math.h"
// 测试Math_Trig_Functions和Math_Trig_Functions_512，以及DSP库中的sin/cos计算精度和时间
// -330 -300 -270 -240 -210 -180 -150 -120 -90 -60 -30 0 30 60 90 120 150 180 210 240 270 300 330
//void Sin_Cos_Test(void)
//{
//  int16_t sin_cos_tab_1[46],sin_cos_tab_2[46],sin_cos_tab_3[46];
//  Trig_Components Trig_temp;
//  uint16_t i = 0;
//  uint16_t timer_cnt_1,timer_cnt_2,timer_cnt_3;
//  float32_t sin_f,cos_f;
//  
//  TIM6->CNT = 0;
//  for(i = 0;i < 23;i++)
//  {
//    Trig_temp = Math_Trig_Functions((int32_t)((i*30 - 330) << 15) / 180);
//    sin_cos_tab_1[i] = Trig_temp.hSin;
//    sin_cos_tab_1[23+i] = Trig_temp.hCos;
//  }
//  timer_cnt_1 = TIM6->CNT;
//  
//  TIM6->CNT = 0;
//  for(i = 0;i < 23;i++)
//  {
//    Trig_temp = Math_Trig_Functions_512((int32_t)((i*30 - 330) << 15) / 180);
//    sin_cos_tab_2[i] = Trig_temp.hSin;
//    sin_cos_tab_2[23+i] = Trig_temp.hCos;
//  }
//  timer_cnt_2 = TIM6->CNT;
//  
//  TIM6->CNT = 0;
//  for(i = 0;i < 23;i++)
//  {
//    sin_f = arm_sin_f32((float32_t)(i*30 - 330)/180*3.1416);
//    cos_f = arm_cos_f32((float32_t)(i*30 - 330)/180*3.1416);
//    sin_cos_tab_3[i] = sin_f * 32767;
//    sin_cos_tab_3[23+i] = cos_f * 32767;
//  }
//  timer_cnt_3 = TIM6->CNT;
//  
//  for(i = 0;i < 23;i++)
//  {
//    DEBUG_Printf("sin(%d) = %d, %d, %d  cos(%d) = %d, %d, %d\r\n",(i*30 - 330),sin_cos_tab_1[i],sin_cos_tab_2[i],sin_cos_tab_3[i],(i*30 - 330),sin_cos_tab_1[23+i],sin_cos_tab_2[23+i],sin_cos_tab_3[23+i]);
//  }
//  
//  DEBUG_Printf("Time = %d, %d, %d\r\n",timer_cnt_1,timer_cnt_2,timer_cnt_3);
//}

#endif

